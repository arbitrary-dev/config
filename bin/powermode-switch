#!/bin/sh

CURR=`cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor`

if [[ "$1" == "-i" ]]; then
  echo $CURR
  exit
fi

# CPU
[ $CURR = performance ] && MODE=powersave || MODE=performance
for c in `ls -d /sys/devices/system/cpu/cpu[0-9]*`; do
  echo $MODE > $c/cpufreq/scaling_governor
done
echo "CPU's set to $MODE mode."

_remove() {
  if [[ -d /sys/bus/pci/devices/$1 && $MODE = powersave ]]; then
    echo 1 > /sys/bus/pci/devices/$1/remove
    echo "$2 was removed from PCI bus."
  fi
}

modprobe -r nvidia
if ! lsmod | grep -q nvidia; then
  _remove "0000:01:00.0" "Nvidia VGA"
fi

_remove "0000:01:00.1" "Nvidia audio"
_remove "0000:00:1f.6" "Ethernet"

# Bluetooth
BT_IDX=`rfkill list | grep -i bluetooth | head -1 | cut -d: -f1`
if [ $MODE = performance ]; then
  rfkill unblock $BT_IDX
  echo "Bluetooth enabled"
elif bluetoothctl info | grep -q "Connected: yes"; then
  echo "Unable to disable bluetooth, following devices connected:"
  bluetoothctl info | grep "Name:" | cut -d\  -f2-
else
  rfkill block $BT_IDX
  echo "Bluetooth disabled"
fi

powertop --auto-tune
