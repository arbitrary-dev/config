#!/bin/sh

CURR=`cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor`
echo "Current mode: $CURR"

# CPU
[ $CURR = performance ] && MODE=powersave || MODE=performance
for c in `ls -d /sys/devices/system/cpu/cpu[0-9]*`; do
  sudo sh -c "echo $MODE > $c/cpufreq/scaling_governor" || exit 1
done
echo "CPU's set to $MODE mode."

_remove() {
  if [[ -d /sys/bus/pci/devices/$1 && $MODE = powersave ]]; then
    sudo sh -c "echo 1 > /sys/bus/pci/devices/$1/remove" || exit 1
    echo "$2 was removed from PCI bus."
  fi
}

modprobe -r nvidia
if ! lsmod | grep -q nvidia; then
  _remove "0000:01:00.0" "Nvidia VGA"
fi

_remove "0000:01:00.1" "Nvidia audio"
_remove "0000:00:1f.6" "Ethernet"

# Bluetooth
BT_IDX=`rfkill list | grep -i bluetooth | head -1 | cut -d: -f1`
if [ $MODE = performance ]; then
  sudo rfkill unblock $BT_IDX || exit 1
  echo "Bluetooth enabled"
elif bluetoothctl info | grep -q "Connected: yes"; then
  echo
  echo "Unable to disable bluetooth, following devices connected:"
  bluetoothctl info | grep "Name:" | cut -d\  -f2-
else
  sudo rfkill block $BT_IDX || exit 1
  echo "Bluetooth disabled"
fi

if [[ ! -f /tmp/.powertop-tuned ]]; then
  echo
  sudo powertop --auto-tune \
  && touch /tmp/.powertop-tuned
fi
